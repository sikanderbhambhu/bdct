name: Build

on:
  push:
  workflow_dispatch:

env:
  PACT_BROKER_BASE_URL: https://epam7.pactflow.io
  PACT_BROKER_TOKEN: 0seO-geVlONnjCudc78FxQ
  # PACT_BROKER_TOKEN: ${{ secrets.PACTFLOW_TOKEN_FOR_CI_CD_WORKSHOP }}
  BASE_URL: https://epam7.pactflow.io
  GIT_COMMIT: ${{ github.sha }}
  GIT_REF: ${{ github.ref }}

jobs:
#   Generate-Consumer-Contracts:
#     runs-on: windows-latest
#     strategy:
#       matrix:
#         pact_provider:
#           ["get-employee-api-provider"]
#     steps:
#       - name: Checkout Consumer Code
#         uses: actions/checkout@v2

#       - name: Install Node
#         uses: actions/setup-node@v2-beta
#         with:
#           node-version: '16.15.1'

#       - name: Installing All The Packages
#         run: npm install --f

#       - name: Downloading PACT Ruby Standalone
#         run: curl -LO https://github.com/pact-foundation/pact-ruby-standalone/releases/download/v1.91.0/pact-1.91.0-win32.zip
      
#       - name: Unzipping PACT Ruby Standalone      
#         run: Powershell Expand-Archive pact-1.91.0-win32.zip

#       - name: Executing Tests For ${{ matrix.pact_provider }}
#         run: npm run consumerTest
#         env:
#           PACT_PROVIDER: ${{ matrix.pact_provider }}

#       - name: Publish Pacts For ${{ matrix.pact_consumer }} & ${{ github.ref }}
#         run: npm run publish:consumerA
#         env:
#           PACT_PROVIDER: ${{ matrix.pact_provider }}

#   # Runs on branches as well, so we know the status of our PRs
#   Can-I-Deploy-Consumer:
#     runs-on: windows-latest
#     needs: Generate-Consumer-Contracts
#     steps:
#       - uses: actions/checkout@v2
#       - uses: actions/setup-node@v2-beta
#         with:
#           node-version: '16.15.1'
#       - name: Installing All The Packages For ${{ matrix.pact_provider }}
#         run: npm install --f

#       - name: Downloading & Unzipping PACT Ruby Standalone On Windows Machine
#       - run: curl -LO https://github.com/pact-foundation/pact-ruby-standalone/releases/download/v1.91.0/pact-1.91.0-win32.zip
#       - run: Powershell Expand-Archive pact-1.91.0-win32.zip

#       - name: Executing "Can I deploy?" Command For Consumer
#         run: npm run can-i-deploy-consumer


  Trigger-Employee-API:
    runs-on: windows-latest
    strategy:
      matrix:
        pact_provider:
          ["get-employee-api-provider"]
    steps:    
      - name: Install Node
        uses: actions/setup-node@v2-beta
        with:
          node-version: '16.15.1'

      - name: Checkout Provider Code
        uses: actions/checkout@v2
        
      - name: Installing All The Packages
        run: npm install --f

      - name: Starting Employee API
        run: npm run start:employeeAPI        


  Run-Provider-Tests:
    runs-on: windows-latest
    needs: Trigger-Employee-API
    strategy:
      matrix:
        pact_provider:
          ["get-employee-api-provider"]
    steps:    
      - name: Install Node
        uses: actions/setup-node@v2-beta
        with:
          node-version: '16.15.1'

      - name: Checkout Provider Code
        uses: actions/checkout@v2

      - name: Installing All The Packages
        run: npm install --f

      - name: Executing Tests For ${{ matrix.pact_provider }}
        run: npm run providerTest
        env:
          PACT_PROVIDER: ${{ matrix.pact_provider }}

      - name: Downloading PACT Ruby Standalone
        run: curl -LO https://github.com/pact-foundation/pact-ruby-standalone/releases/download/v1.91.0/pact-1.91.0-win32.zip
      
      - name: Unzipping PACT Ruby Standalone      
        run: Powershell Expand-Archive pact-1.91.0-win32.zip

      - name: Publish pacts for ${{ matrix.pact_consumer }} and ${{ github.ref }}
        run: npm run publish:EmployeeApi
        env:
          PACT_PROVIDER: ${{ matrix.pact_provider }}

#   # Runs on branches as well, so we know the status of our PRs
#   Can-I-Deploy-Provider:
#     runs-on: windows-latest
#     needs: Generate-Provider-Contracts
#     steps:
#       - uses: actions/checkout@v2
#       - uses: actions/setup-node@v2-beta
#         with:
#           node-version: '16.15.1'
#       - name: Installing All The Packages For ${{ matrix.pact_provider }}
#         run: npm install --f
      
#       - run: curl -LO https://github.com/pact-foundation/pact-ruby-standalone/releases/download/v1.91.0/pact-1.91.0-win32.zip
#       - run: Powershell Expand-Archive pact-1.91.0-win32.zip

#       - name: Executing "Can I deploy?" Command For Provider
#         run: npm run can-i-deploy-provider




  # Only deploy from master
#   deploy:
#     runs-on: ubuntu-latest
#     needs: Can-I-Deploy-Consumer
#     steps:
#       - uses: actions/checkout@v2
#       - run: docker pull pactfoundation/pact-cli:latest
#       - name: Deploy
#         run: GIT_BRANCH=${GIT_REF:11} make deploy
#         if: github.ref == 'refs/heads/master'
